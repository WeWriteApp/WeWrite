rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Pages collection
    match /pages/{pageId} {
      // Allow reading if user is the owner
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;

      // Allow reading public pages that don't belong to a group
      allow read: if resource.data.isPublic == true && resource.data.groupId == null;

      // For pages that belong to a group, check group access
      allow read: if resource.data.groupId != null && (
        // Public groups: all pages (public and private) are accessible to everyone
        get(/databases/$(database)/documents/groups/$(resource.data.groupId)).data.isPublic == true ||

        // Private groups: only members can access
        (request.auth != null &&
          exists(/databases/$(database)/documents/groups/$(resource.data.groupId)/members/$(request.auth.uid)))
      );

      // Allow writing if user is the owner
      allow write: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // User profiles
    match /users/{userId} {
      // Allow reading any user profile
      allow read: if true;

      // Allow writing only to own profile
      allow write: if request.auth != null && userId == request.auth.uid;
    }

    // Username history
    match /usernameHistory/{docId} {
      // Allow reading any username history
      allow read: if true;

      // Allow writing only to own history
      allow write: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Feature flags - only admins can modify
    match /config/featureFlags {
      // Allow reading by anyone
      allow read: if true;

      // Only allow writing by admin users
      allow write: if request.auth != null &&
        (request.auth.token.email == 'jamiegray2234@gmail.com' ||
         exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid)));
    }

    // Follower privacy rules
    match /userFollowers/{userId} {
      // Only allow the user to read their own followers
      allow read: if request.auth != null && userId == request.auth.uid;
      // Only allow authenticated users to write
      allow write: if request.auth != null;
    }

    match /userFollowing/{userId} {
      // Only allow the user to read who they're following
      allow read: if request.auth != null && userId == request.auth.uid;
      // Only allow authenticated users to write
      allow write: if request.auth != null;
    }

    match /follows/{followId} {
      // Only allow the users involved in the follow relationship to read it
      allow read: if request.auth != null &&
        (request.auth.uid == resource.data.followerId ||
         request.auth.uid == resource.data.followedId);
      // Only allow authenticated users to write
      allow write: if request.auth != null;
    }

    // Default rule - allow reading but restrict writing
    match /{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}
