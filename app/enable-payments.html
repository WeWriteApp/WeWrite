<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable Payments Feature</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Enable Payments Feature Flag</h1>
        
        <div class="info">
            <strong>Instructions:</strong><br>
            1. This page will automatically check and enable the payments feature flag<br>
            2. Check the console output below for status updates<br>
            3. Once enabled, refresh your WeWrite application to see the changes
        </div>

        <div>
            <button onclick="checkFlags()">Check Feature Flags</button>
            <button onclick="enablePayments()">Enable Payments</button>
            <button onclick="clearConsole()">Clear Console</button>
        </div>

        <div id="status"></div>
        <div id="console-output"></div>
    </div>

    <script type="module">
        // Import Firebase configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCXAIBQqj7AgEPIHMuQXjCqNe-9mt1aUG4",
            authDomain: "wewrite-ccd82.firebaseapp.com",
            databaseURL: "https://wewrite-ccd82-default-rtdb.firebaseio.com",
            projectId: "wewrite-ccd82",
            storageBucket: "wewrite-ccd82.appspot.com",
            messagingSenderId: "533371797590",
            appId: "1:533371797590:web:2398b273ef4e9cdeccbbf7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Console output element
        const consoleOutput = document.getElementById('console-output');
        const statusDiv = document.getElementById('status');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.textContent += `[${timestamp}] ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            console.log(message);
        }

        function setStatus(message, type = 'info') {
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function checkFlags() {
            try {
                log('ðŸ” Checking current feature flags...');
                setStatus('Checking feature flags...', 'info');
                
                const featureFlagsRef = doc(db, 'config', 'featureFlags');
                const featureFlagsDoc = await getDoc(featureFlagsRef);
                
                if (featureFlagsDoc.exists()) {
                    const flags = featureFlagsDoc.data();
                    log('ðŸ“‹ Current feature flags: ' + JSON.stringify(flags, null, 2));
                    
                    if (flags.payments === true) {
                        log('âœ… Payments feature flag is ENABLED');
                        setStatus('âœ… Payments feature flag is ENABLED', 'success');
                    } else {
                        log('âŒ Payments feature flag is DISABLED or not set');
                        setStatus('âŒ Payments feature flag is DISABLED', 'error');
                    }
                } else {
                    log('âŒ No feature flags document found in Firebase');
                    setStatus('âŒ No feature flags document found', 'error');
                }
            } catch (error) {
                log('âŒ Error checking feature flags: ' + error.message);
                setStatus('âŒ Error checking feature flags: ' + error.message, 'error');
            }
        }

        async function enablePayments() {
            try {
                log('ðŸ”§ Enabling payments feature flag...');
                setStatus('Enabling payments feature flag...', 'info');
                
                const featureFlagsRef = doc(db, 'config', 'featureFlags');
                const featureFlagsDoc = await getDoc(featureFlagsRef);
                
                let currentFlags = {};
                if (featureFlagsDoc.exists()) {
                    currentFlags = featureFlagsDoc.data();
                    log('ðŸ“‹ Current feature flags: ' + JSON.stringify(currentFlags, null, 2));
                } else {
                    log('ðŸ“‹ No feature flags document found, creating new one...');
                }
                
                const updatedFlags = {
                    ...currentFlags,
                    payments: true,
                    map_view: currentFlags.map_view || false,
                    calendar_view: currentFlags.calendar_view || false,
                    groups: currentFlags.groups !== undefined ? currentFlags.groups : true,
                    notifications: currentFlags.notifications || false,
                    link_functionality: currentFlags.link_functionality !== undefined ? currentFlags.link_functionality : true,
                    daily_notes: currentFlags.daily_notes || false
                };
                
                log('ðŸ’¾ Updating feature flags...');
                await setDoc(featureFlagsRef, updatedFlags);
                
                log('âœ… Payments feature flag enabled successfully!');
                log('ðŸ“Š Updated feature flags: ' + JSON.stringify(updatedFlags, null, 2));
                log('ðŸ”„ Please refresh your WeWrite application to see the changes.');
                setStatus('âœ… Payments feature flag enabled successfully! Please refresh your WeWrite application.', 'success');
                
            } catch (error) {
                log('âŒ Error enabling payments feature flag: ' + error.message);
                setStatus('âŒ Error enabling payments: ' + error.message, 'error');
            }
        }

        function clearConsole() {
            consoleOutput.textContent = '';
            statusDiv.innerHTML = '';
        }

        // Make functions available globally
        window.checkFlags = checkFlags;
        window.enablePayments = enablePayments;
        window.clearConsole = clearConsole;

        // Auto-run on page load
        log('ðŸš€ Feature flag management page loaded!');
        log('ðŸ” Running automatic feature flag check...');
        checkFlags();
        
        // Auto-enable payments after a short delay
        setTimeout(() => {
            log('ðŸ”§ Auto-enabling payments feature flag...');
            enablePayments();
        }, 2000);
    </script>
</body>
</html>
