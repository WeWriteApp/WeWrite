# WeWrite Payouts System Architecture

## Overview

The WeWrite payouts system enables writers to receive real money from their earnings generated by other writers' allocations. Here's how it works in plain English:

## How Money Flows Through WeWrite

### 1. **Money Comes In** (Revenue)
- Writers pay WeWrite monthly subscriptions ($10, $20, $30/month)
- This gives them "allocation tokens" to distribute to other writers
- Example: $30/month = 300 allocation tokens

### 2. **Money Gets Allocated** (Distribution)
- Writers use their tokens to allocate money to pages/writers they support
- Each token = $0.10 USD that goes to the recipient
- Example: Allocating 50 tokens = $5.00 to the recipient writer

### 3. **Money Becomes Earnings** (Accumulation)
- Recipients accumulate USD earnings from allocations they receive
- Earnings are tracked monthly and start as "pending"
- At month-end, pending earnings become "available" for payout

### 4. **Money Gets Paid Out** (Withdrawal)
- Writers can request payouts of their available earnings
- Minimum payout: $25.00
- WeWrite takes 7% platform fee
- Stripe takes $0.25 per transfer
- Money goes directly to writer's connected bank account

## Technical Architecture

### Core Services

#### **UsdEarningsService**
- **Purpose**: Tracks USD earnings from allocations
- **Key Functions**:
  - `processUsdAllocation()`: Records when someone allocates USD to a writer
  - `requestPayout()`: Handles payout requests from writers
  - `getCompleteWriterEarnings()`: Gets all earnings data for a writer

#### **StripePayoutService** 
- **Purpose**: Executes actual bank transfers via Stripe
- **Key Functions**:
  - `createStripeTransfer()`: Sends money to writer's bank account
  - `verifyStripeAccount()`: Ensures bank account can receive payouts

#### **PayoutEligibilityService**
- **Purpose**: Validates if a writer can receive payouts
- **Checks**:
  - Has earnings > $0
  - Meets $25 minimum threshold
  - Has connected & verified bank account
  - No active disputes
  - Passes compliance checks

### Data Flow

```
1. User A subscribes ($30/month) → Gets 300 tokens
2. User A allocates 50 tokens to User B's page → User B earns $5.00
3. UsdEarningsService records $5.00 earning for User B (status: pending)
4. At month-end: Earnings become "available"
5. User B requests payout of $25.00 available earnings
6. PayoutEligibilityService validates User B can receive payouts
7. StripePayoutService transfers $23.25 to User B's bank ($25 - 7% fee - $0.25)
```

### Database Collections

#### **Writer USD Earnings** (`DEV_writerUsdEarnings`)
- Tracks monthly earnings per writer
- Status: `pending` → `available` → `paid_out`

#### **Writer USD Balances** (`DEV_writerUsdBalances`) 
- Current balance summary per writer
- Fields: `totalEarned`, `pendingUsdCents`, `availableUsdCents`

#### **USD Payouts** (`DEV_usdPayouts`)
- Payout request records
- Status: `pending` → `processing` → `completed`/`failed`

#### **USD Allocations** (`DEV_usdAllocations`)
- Individual allocation records
- Links subscriber to recipient with USD amount

## API Endpoints

### **GET/POST /api/payouts/earnings**
- Get earnings data and request payouts
- Used by: Settings > Earnings page

### **POST /api/stripe/create-account-link** 
- Creates Stripe Connect onboarding links
- Auto-fills business website as `https://www.getwewrite.app/`

### **POST /api/stripe/account-status**
- Checks bank account connection status
- Returns: connected, verified, bank details

## User Interface

### **Settings > Earnings > Payouts Tab**
1. **Bank Account Section**:
   - Shows "Add Bank Account" if none connected
   - Shows "Edit Bank Connection" + bank details if connected
   - Proper loading states (no longer shows empty state while loading)

2. **Automatic Payouts Section** (only if bank verified):
   - Toggle to enable/disable auto-payouts
   - Minimum amount setting
   - Frequency setting (monthly/weekly)

3. **Payout History**:
   - List of past payouts with status
   - Amount, date, bank account used

## Fee Structure

- **Platform Fee**: 7% of gross earnings
- **Stripe Transfer Fee**: $0.25 per payout
- **Minimum Payout**: $25.00
- **Example**: $30 earnings → $27.75 net payout ($30 - $2.10 platform fee - $0.25 Stripe fee)

## Current Implementation Status

✅ **Fully Implemented**:
- USD allocation tracking and earnings accumulation
- Bank account connection via Stripe Connect with auto-filled business info
- Payout eligibility checking with comprehensive validation
- Manual and automatic payout request flows
- Real-time bank account status updates
- Payout history with real API data and refresh functionality
- Automatic payout preferences with API persistence
- Monthly earnings processing with cron job setup
- Payout status synchronization with Stripe
- Proper loading states and error handling
- Dark mode compatible UI components

✅ **Production Ready**:
- Cron job endpoints for automated processing
- Comprehensive monitoring and logging
- Error handling with correlation IDs
- Security with API key authentication
- Admin dashboard integration

⚠️ **Requires Setup**:
- Cron job scheduling (documented in CRON_JOB_SETUP.md)
- Production environment variables
- Stripe webhook configuration

❌ **Future Enhancements**:
- Dispute/chargeback handling
- International payout support (currently US-only)
- Advanced retry logic for complex failure scenarios
- Multi-currency support

## Implementation Completed ✅

1. **Fixed loading states** - Proper loading spinners instead of empty states
2. **Implemented automatic payout scheduling** - API integration with preferences
3. **Added real-time payout status tracking** - Automatic refresh and status sync
4. **Set up monthly earnings processing** - Cron job endpoints and documentation
5. **Improved payout history UI** - Real API data with refresh functionality
6. **Enhanced bank account management** - Status detection and proper UI states

## Production Deployment Checklist

- [ ] Set up cron jobs (see CRON_JOB_SETUP.md)
- [ ] Configure environment variables (CRON_API_KEY, etc.)
- [ ] Test end-to-end payout flow in staging
- [ ] Verify Stripe webhook endpoints
- [ ] Set up monitoring and alerting
- [ ] Document incident response procedures

## Future Enhancements

1. **International bank support** - Expand beyond US-only
2. **Multi-currency payouts** - Support EUR, GBP, etc.
3. **Advanced dispute handling** - Automated chargeback management
4. **Enhanced analytics** - Detailed payout reporting and insights
